name: ğŸš€ NuGet Package CI/CD

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ (å¦‚ v1.0.0, v1.2.3)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'EasyCodeBuilder/EasyCodeBuilder.csproj'
  PACKAGE_OUTPUT_DIRECTORY: ${{ github.workspace }}/output
  NUGET_SOURCE_URL: 'https://api.nuget.org/v3/index.json'

jobs:
  permission-check:
    name: ğŸ” Permission Check
    runs-on: ubuntu-latest
    outputs:
      is-authorized: ${{ steps.check.outputs.authorized }}
    
    steps:
    - name: ğŸ” Check user permissions
      id: check
      run: |
        echo "Triggered by: ${{ github.actor }}"
        echo "Repository owner: ${{ github.repository_owner }}"
        echo "Event name: ${{ github.event_name }}"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯ä»“åº“æ‰€æœ‰è€…
        if [ "${{ github.actor }}" = "${{ github.repository_owner }}" ]; then
          echo "âœ… User is repository owner - authorized"
          echo "authorized=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ User is not repository owner - unauthorized"
          echo "authorized=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: permission-check
    if: needs.permission-check.outputs.is-authorized == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: ğŸ”¨ Build project
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore
      
    - name: ğŸ§ª Run tests (if exists)
      run: |
        if [ -d "tests" ] || [ -d "test" ] || [ -d "Tests" ] || [ -d "Test" ]; then
          echo "Running tests..."
          dotnet test --configuration Release --no-build --verbosity normal
        else
          echo "No test projects found, skipping tests"
        fi
      
  publish:
    name: ğŸ“¦ Publish to NuGet
    needs: [permission-check, build-and-test]
    runs-on: ubuntu-latest
    environment: production  # ğŸ”’ éœ€è¦environmentå®¡æ‰¹
    if: needs.permission-check.outputs.is-authorized == 'true'
    
    steps:
    - name: ğŸ” Final permission verification
      run: |
        echo "ğŸ” Final verification - User: ${{ github.actor }}"
        echo "âœ… Authorized user confirmed: ${{ github.actor }}"
        
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ·ï¸ Get version from tag or input
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"
        
    - name: ğŸ“ Update project version
      run: |
        sed -i "s/<Version>.*<\/Version>/<Version>${{ steps.version.outputs.VERSION }}<\/Version>/g" ${{ env.PROJECT_PATH }}
        echo "Updated project version to ${{ steps.version.outputs.VERSION }}"
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}
      
    - name: ğŸ”¨ Build project
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore
      
    - name: ğŸ“¦ Create NuGet package
      run: |
        dotnet pack ${{ env.PROJECT_PATH }} \
          --configuration Release \
          --no-build \
          --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
          
    - name: ğŸ“‹ List generated packages
      run: ls -la ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
      
    - name: ğŸš€ Publish package to NuGet
      run: |
        echo "ğŸš€ Publishing as authorized user: ${{ github.actor }}"
        dotnet nuget push "${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source ${{ env.NUGET_SOURCE_URL }} \
          --skip-duplicate
          
    - name: ğŸ“¸ Upload package artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg
        
    - name: ğŸ‰ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## ğŸš€ Release ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ‘¤ Released by
          **${{ github.actor }}** (Repository Owner)
          
          ### ğŸ“¦ NuGet Package
          - **Package**: [Fengb3.EasyCodeBuilder](https://www.nuget.org/packages/Fengb3.EasyCodeBuilder/)
          - **Version**: ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ“¥ Installation
          ```bash
          dotnet add package Fengb3.EasyCodeBuilder --version ${{ steps.version.outputs.VERSION }}
          ```
          
          ### ğŸ”— Links
          - [NuGet Package](https://www.nuget.org/packages/Fengb3.EasyCodeBuilder/${{ steps.version.outputs.VERSION }})
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ---
          *This release was automatically generated by GitHub Actions* ğŸ¤–
        draft: false
        prerelease: false 